<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestion des Horaires - Connexion</title>
  <style>
    /* ============ RESET / BASE ============ */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --primary:#2699e7; --primary-hover:#1d7dc2;
      --text:#333; --muted:#555;
      --border:#e1e5e9;
      --ok-bg:#d4edda; --ok-text:#155724; --ok-bd:#c3e6cb;
      --err-bg:#f8d7da; --err-text:#721c24; --err-bd:#f5c6cb;
    }

    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    /* ============ LAYOUT ============ */
    .container{ width:100%; max-width:420px; padding:20px; }
    .card{
      background:#fff; padding:40px 30px; border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }

    h1{ color:var(--text); font-size:24px; margin-bottom:22px; text-align:center; }

    .logo{ display:flex; justify-content:center; margin-bottom:16px; }
    .logo img{ width:80px; height:80px; }

    .form-group{ margin-bottom:16px; }
    label{ display:block; margin-bottom:6px; color:var(--muted); font-weight:500; }
    input{
      width:100%; padding:12px; border:2px solid var(--border); border-radius:10px; font-size:14px;
      transition:border-color .2s ease;
    }
    input:focus{ outline:none; border-color:var(--primary); }

    .btn{
      width:100%; padding:12px; border:none; border-radius:10px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:600; font-size:16px;
      transition: background .2s ease, transform .04s ease;
    }
    .btn:hover{ background:var(--primary-hover); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.7; cursor:not-allowed; }

    .row{ margin-top:10px; display:flex; align-items:center; gap:10px; }

    .message{
      margin-top:14px; padding:10px; border-radius:8px; font-size:14px; display:none;
      word-wrap:break-word;
    }
    .message.success{ background:var(--ok-bg); color:var(--ok-text); border:1px solid var(--ok-bd); display:block; }
    .message.error{ background:var(--err-bg); color:var(--err-text); border:1px solid var(--err-bd); display:block; }

    .hint{ margin-top:10px; text-align:center; color:#666; font-size:12px; }

    /* Spinner minimal */
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid transparent;border-top-color:#fff;border-left-color:#fff;
      animation:spin .6s linear infinite; display:none;
    }
    .btn.loading .spinner{ display:inline-block; }
    .btn.loading .btn-text{ opacity:.0; }

    @keyframes spin{ to{ transform:rotate(360deg);} }

    @media (max-width:480px){ .card{ padding:32px 22px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-labelledby="title">
      <h1 id="title">Gestion des Horaires</h1>

      <div class="logo" aria-hidden="true">
        <!-- Ic√¥ne horloge inline (SVG base64 possible) -->
        <img alt="" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDIyQzE3LjUyMjggMjIgMjIgMTcuNTIyOCAyMiAxMkMyMiA2LjQ3NzE1IDE3LjUyMjggMiAxMiAyQzYuNDc3MTUgMiAyIDYuNDc3MTUgMiAxMkMyIDE3LjUyMjggNi40NzcxNSAyMiAxMiAyMloiIHN0cm9rZT0iIzI2OTlFNyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTEyIDZWN0UxMiA3IDEyIDcgMTIgN1oiIGZpbGw9IiMyNjk5RTciLz4KPHBhdGggZD0iTTEyIDEwVjE2IiBzdHJva2U9IiMyNjk5RTciIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo="/>
      </div>

      <form id="loginForm" class="login-form" novalidate>
        <div class="form-group">
          <label for="email">Email</label>
          <input autocomplete="username" type="email" id="email" name="email" required placeholder="ex: nom@domaine.com"/>
        </div>

        <button type="submit" id="btnLogin" class="btn">
          <span class="btn-text">Se connecter par email</span>
          <span class="spinner" aria-hidden="true"></span>
        </button>

        <div id="msg" class="message" aria-live="polite"></div>
      </form>

      <div class="hint">Entrez votre email pour recevoir un lien de connexion (admins et employ√©s).</div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './config.js';

    // DOM refs
    const form = document.getElementById('loginForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('btnLogin');

    const showMessage = (text, type='error') => {
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
    };

    const setLoading = (isLoading) => {
      if (isLoading) {
        btn.classList.add('loading');
        btn.setAttribute('disabled', 'true');
      } else {
        btn.classList.remove('loading');
        btn.removeAttribute('disabled');
      }
    };

    // Check bypass via URL (pour dev/test seulement)
    function checkBypass() {
      const urlParams = new URLSearchParams(window.location.search);
      const bypass = urlParams.get('bypass');
      if (bypass === 'admin') {  // Change 'admin' en un token secret si tu veux (ex: 'monsecret123')
        console.log('üîì Bypass activ√© : Redirection admin');
        showMessage('Acc√®s admin direct (mode test).', 'success');
        setTimeout(() => window.location.href = 'admin.html?bypass=admin', 1500);  // Passe le param pour les sous-pages si besoin
        return true;
      }
      return false;
    }

    // Redirection s√©curis√©e selon r√¥le (table `admins`)
    async function redirectByRole() {
      console.log('üîç D√©but check r√¥le...');
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) {
        console.error('Erreur session:', sessionError);
        return;
      }
      if (!session?.user) {
        console.log('Pas de session user');
        return;
      }

      const userId = session.user.id;
      console.log('User ID:', userId, 'Email:', session.user.email);

      const { data: adminRow, error } = await supabase
        .from('admins')
        .select('id, email')
        .eq('id', userId)
        .maybeSingle();

      console.log('Query admins r√©sultat:', adminRow, 'Erreur:', error);

      if (error) {
        console.error('Erreur check admin:', error.message);
        showMessage('Erreur lors du check de r√¥le. Contacte un dev.', 'error');
        setTimeout(() => window.location.href = 'employe.html', 2000);
        return;
      }

      const target = adminRow ? 'admin.html' : 'employe.html';
      console.log(`Redirection vers: ${target}`);
      window.location.href = target;
    }

    // Connexion par email (Magic Link pour admins et employ√©s)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.style.display = 'none';

      const email = document.getElementById('email').value.trim();

      if (!email) {
        showMessage('Veuillez remplir votre email.');
        return;
      }

      console.log('Envoi Magic Link pour:', email);

      setLoading(true);
      try {
        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) {
          console.error('Erreur Magic Link:', error.message);
          showMessage(error.message.includes('not confirmed') ? 'Confirmez d\'abord votre email.' : 'Erreur : V√©rifiez votre email et r√©essayez.');
        } else {
          showMessage('Lien envoy√© ! V√©rifiez votre bo√Æte de r√©ception (et spam). Cliquez dessus pour vous connecter.', 'success');
        }
      } catch (err) {
        console.error('Catch Magic Link:', err);
        showMessage("Une erreur est survenue.");
      } finally {
        setLoading(false);
      }
    });

    // Au chargement : Check bypass D'ABORD, puis session
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Page charg√©e...');
      if (checkBypass()) {
        return;  // Si bypass, on skip le reste
      }
      console.log('Check session auto...');
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        console.log('Session existante, user:', session.user.email);
        await redirectByRole();
      } else {
        console.log('Pas de session existante');
      }
    });

    // √âcoute les changements auth (important pour Magic Link)
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('√âv√©nement auth:', event);
      if (event === 'SIGNED_IN' && session?.user) {
        showMessage('Connexion confirm√©e ! Redirection‚Ä¶', 'success');
        await redirectByRole();
      } else if (event === 'SIGNED_OUT') {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
