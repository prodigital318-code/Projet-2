<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - v3.3 (QR Fixe Unique)</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* TOUS LES STYLES INCLUS - RIEN OMI (header, forms, modals, toasts, responsive, etc.) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #28a745, #007bff, #ffc107); }
        .admin-info { display: flex; align-items: center; gap: 15px; }
        .admin-avatar { width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-logout { padding: 10px 20px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-logout:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(220,53,69,0.3); }
        .admin-content { display: grid; grid-template-columns: 400px 1fr; gap: 20px; }
        .section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; }
        .section::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #007bff; }
        h2 { margin-bottom: 20px; color: #007bff; font-size: 1.5em; }
        h3 { margin-top: 20px; color: #555; font-size: 1.2em; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .btn-add { width: 100%; padding: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(40,167,69,0.3); }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar input { flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; }
        .btn-filter { padding: 12px 20px; background: linear-gradient(135deg, #6c757d, #5a6268); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .btn-filter:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(108,117,125,0.3); }
        .employes-list { display: grid; gap: 15px; max-height: 600px; overflow-y: auto; padding-right: 10px; }
        .employes-list::-webkit-scrollbar { width: 6px; } .employes-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; } .employes-list::-webkit-scrollbar-thumb { background: #007bff; border-radius: 3px; }
        .employe-card { display: flex; flex-direction: column; gap: 10px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #007bff; cursor: pointer; transition: all 0.3s; }
        .employe-card:hover { transform: translateX(5px); background: #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .employe-name { font-weight: bold; font-size: 18px; color: #333; }
        .employe-details { font-size: 14px; color: #666; }
        .employe-status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-active { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; }
        .status-inactive { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; }
        .btn-small { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; margin: 2px; transition: all 0.3s; }
        .btn-selfie { background: #17a2b8; color: white; } .btn-selfie:hover { background: #138496; }
        .btn-horaires { background: #ffc107; color: #000; } .btn-horaires:hover { background: #e0a800; }
        .btn-qr-fixed { background: #28a745; color: white; width: 100%; margin-top: 10px; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-qr-fixed:hover { background: #218838; transform: translateY(-2px); }
        #qr-canvas { display: block; margin: 10px auto; border: 1px solid #ddd; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content.large { max-width: 900px; }
        .modal-header { padding: 25px 30px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; } .close:hover { color: #dc3545; }
        .modal-body { padding: 30px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #007bff; }
        .info-item label { font-weight: 600; color: #555; }
        .info-item value { font-weight: bold; color: #333; }
        .modal-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; }
        .btn-modal { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-transform: uppercase; }
        .btn-conges { background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; } .btn-conges:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255,193,7,0.3); }
        .btn-horaires { background: linear-gradient(135deg, #17a2b8, #138496); color: white; } .btn-horaires:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(23,162,184,0.3); }
        .btn-supprimer { background: linear-gradient(135deg, #dc3545, #c82333); color: white; grid-column: 1 / -1; } .btn-supprimer:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(220,53,69,0.3); }
        .selfies-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .selfie-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
        .conges-list { margin-top: 20px; }
        .conge-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #28a745; }
        .conge-item.pending { border-left-color: #ffc107; }
        .conge-item.rejected { border-left-color: #dc3545; }
        .conge-details { flex: 1; }
        .conge-motif { font-weight: bold; color: #333; }
        .conge-dates { font-size: 12px; color: #666; }
        .conge-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .conge-form .form-group { margin-bottom: 15px; }
        .btn-approuver { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px; }
        .btn-rejeter { background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px; }
        .btn-approuver:hover, .btn-rejeter:hover { transform: translateY(-1px); }
        @media (max-width: 768px) { .admin-content { grid-template-columns: 1fr; } .form-row, .conge-form .form-row { grid-template-columns: 1fr; } .info-grid { grid-template-columns: 1fr; } .search-bar { flex-direction: column; } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 2000; transform: translateX(400px); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .toast.error { background: linear-gradient(135deg, #dc3545, #c82333); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Admin - Gestion Employés & QR Fixe (v3.3)</h1>
            <div class="admin-info">
                <div class="admin-avatar" id="admin-avatar">A</div>
                <span id="admin-name">Admin Connecté</span>
                <button class="btn-logout" onclick="logout()">Déconnexion</button>
            </div>
        </div>
        <div class="admin-content">
            <div class="section add-employe-section">
                <h2>➕ Ajouter un Employé</h2>
                <form id="employe-form" class="employe-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom *</label>
                            <input type="text" id="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom</label>
                            <input type="text" id="prenom">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Mot de Passe *</label>
                            <input type="password" id="password" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shift">Shift</label>
                            <select id="shift" onchange="toggleCustomShifts()">
                                <option value="jour">Jour (9h-17h)</option>
                                <option value="nuit">Nuit (21h-5h)</option>
                                <option value="personnalise">Personnalisé (choisissez vos heures matin/soir)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="shifts-personnalises" style="display:none;">
                        <div class="form-group">
                            <label for="heure_debut">Heure début matin (ex: 08:00)</label>
                            <input type="time" id="heure_debut" required>
                        </div>
                        <div class="form-group">
                            <label for="heure_fin">Heure fin soir (ex: 18:00)</label>
                            <input type="time" id="heure_fin" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-add">Ajouter l'Employé</button>
                </form>
                <h3>QR Code Fixe Unique (pour tout le bar)</h3>
                <p>Utilisez ce QR unique pour tous les pointages. Imprimez-le et fixez-le au bar.</p>
                <button class="btn-qr-fixed" onclick="loadAndGenerateFixedQR()">Générer & Télécharger QR Fixe</button>
            </div>
            <div class="section employes-list-section">
                <h2>👥 Liste des Employés (<span id="total-employes">0</span>)</h2>
                <div class="search-bar">
                    <input type="text" id="search" placeholder="Rechercher par nom, email ou shift..." oninput="filterEmployes()">
                    <button class="btn-filter" onclick="filterEmployes()">Filtrer</button>
                </div>
                <div class="employes-list" id="employes-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal Détails Employé -->
    <div id="modal-details" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Détails de l'Employé</h2>
                <span class="close" onclick="closeModal('modal-details')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="info-grid" id="modal-info"></div>
                <div id="selfies-section">
                    <h3>Selfies Récents</h3>
                    <div class="selfies-grid" id="selfies-grid"></div>
                </div>
                <div id="horaires-section">
                    <h3>Horaires Actuels</h3>
                    <p id="horaires-display"></p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-conges" onclick="openCongesModal(selectedEmployeId)">📅 Gérer Congés</button>
                <button class="btn-modal btn-horaires" onclick="editHoraires(selectedEmployeId)">⏰ Modifier Horaires</button>
                <button class="btn-modal btn-supprimer" onclick="confirmDelete(selectedEmployeId)">🗑️ Supprimer Employé</button>
            </div>
        </div>
    </div>

    <!-- Modal Congés -->
    <div id="modal-conges" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="conges-title">Gestion des Congés - <span id="conges-name"></span></h2>
                <span class="close" onclick="closeModal('modal-conges')">&times;</span>
            </div>
            <div class="modal-body">
                <h3>Ajouter un Congé</h3>
                <form id="conge-form" class="conge-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_debut">Date Début *</label>
                            <input type="date" id="date_debut" required>
                        </div>
                        <div class="form-group">
                            <label for="date_fin">Date Fin *</label>
                            <input type="date" id="date_fin" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="motif">Motif *</label>
                        <select id="motif" required>
                            <option value="conges payes">Congés Payés</option>
                            <option value="maladie">Maladie</option>
                            <option value="personnel">Personnel</option>
                            <option value="formation">Formation</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-add-conge">Ajouter Congé</button>
                </form>
                <div class="conges-list" id="conges-list"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script type="module">
        // Config Supabase (tout inclus)
        const SUPABASE_URL = 'https://sxhtqikqklriyjttnyme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhYnVoYHB1Zm9hcmpwZmxxY3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5ODMyOTgsImV4cCI6MjA3NDU1OTI5OH0.bNRvqHfSmk5-PVnUzVfxgU_FWpaKpqgx-VF1_4ec6v4';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let employesData = [];
        let filteredEmployes = [];
        let selectedEmployeId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            await loadAdminInfo(session.user);
            await loadEmployes();
            setupEventListeners();
        });

        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') window.location.href = 'index.html';
        });

        async function loadAdminInfo(user) {
            const { data } = await supabase.from('admins').select('email').eq('id', user.id).single();
            if (data) {
                document.getElementById('admin-name').textContent = `Admin: ${data.email}`;
                document.getElementById('admin-avatar').textContent = data.email.charAt(0).toUpperCase();
            }
        }

        async function loadEmployes() {
            const { data, error } = await supabase.from('employes').select('*').order('nom', { ascending: true });
            if (error) return showToast('Erreur chargement employés: ' + error.message, 'error');
            employesData = data || [];
            filteredEmployes = [...employesData];
            displayEmployes(filteredEmployes);
            document.getElementById('total-employes').textContent = employesData.length;
        }

        function displayEmployes(employes) {
            const list = document.getElementById('employes-list');
            if (!employes.length) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucun employé trouvé.</p>';
                return;
            }
            list.innerHTML = employes.map(emp => {
                const statusClass = emp.active ? 'status-active' : 'status-inactive';
                const statusText = emp.active ? 'Actif' : (emp.disabled_reason ? `Inactif: ${emp.disabled_reason}` : 'Inactif');
                return `
                    <div class="employe-card" onclick="openModal('${emp.id}')">
                        <div class="employe-info-card">
                            <div class="employe-name">${emp.prenom || ''} ${emp.nom}</div>
                            <div class="employe-details">📧 ${emp.email} | ⏰ ${emp.shift} ${emp.heure_debut ? ` (Matin: ${emp.heure_debut} - Soir: ${emp.heure_fin})` : ''}</div>
                        </div>
                        <span class="employe-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        function setupEventListeners() {
            // Ajout employé (sans make_admin, toujours employé normal)
            document.getElementById('employe-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nom = document.getElementById('nom').value.trim();
                const prenom = document.getElementById('prenom').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const shift = document.getElementById('shift').value;
                let heureDebut = null, heureFin = null;
                if (shift === 'personnalise') {
                    heureDebut = document.getElementById('heure_debut').value;
                    heureFin = document.getElementById('heure_fin').value;
                    if (!heureDebut || !heureFin) {
                        showToast('Pour shift personnalisé, choisissez une heure début matin et fin soir.', 'error');
                        return;
                    }
                    // Validation simple : fin > début (optionnel, mais logique)
                    if (heureFin <= heureDebut) {
                        showToast('Heure fin soir doit être après début matin.', 'error');
                        return;
                    }
                }

                const { data, error } = await supabase.rpc('create_employee_complete', {
                    p_nom: nom,
                    p_prenom: prenom,
                    p_email: email,
                    p_password: password,
                    p_shift: shift,
                    p_heure_debut: heureDebut,
                    p_heure_fin: heureFin,
                    p_make_admin: false  // Toujours employé normal
                });
                if (error) return showToast('Erreur création: ' + error.message, 'error');
                showToast('Employé ajouté avec succès ! Utilisez le QR fixe pour son pointage.', 'success');
                document.getElementById('employe-form').reset();
                document.getElementById('shifts-personnalises').style.display = 'none';
                await loadEmployes();
            });

            // Ajout congé (inchangé)
            document.getElementById('conge-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedEmployeId) return;
                const dateDebut = document.getElementById('date_debut').value;
                const dateFin = document.getElementById('date_fin').value;
                const motif = document.getElementById('motif').value;
                if (new Date(dateDebut) > new Date(dateFin)) {
                    showToast('La date de fin doit être après la date de début.', 'error');
                    return;
                }
                const { error } = await supabase.from('conges').insert({
                    user_id: selectedEmployeId,
                    date_debut: dateDebut,
                    date_fin: dateFin,
                    motif
                });
                if (error) return showToast('Erreur ajout congé: ' + error.message, 'error');
                showToast('Congé ajouté ! En attente d\'approbation.', 'success');
                document.getElementById('conge-form').reset();
                await loadConges(selectedEmployeId);
            });
        }

        function toggleCustomShifts() {
            const shift = document.getElementById('shift').value;
            const section = document.getElementById('shifts-personnalises');
            section.style.display = shift === 'personnalise' ? 'grid' : 'none';
            if (shift !== 'personnalise') {
                document.getElementById('heure_debut').value = '';
                document.getElementById('heure_fin').value = '';
            }
        }

        function filterEmployes() {
            const term = document.getElementById('search').value.toLowerCase();
            filteredEmployes = employesData.filter(emp =>
                emp.nom.toLowerCase().includes(term) ||
                (emp.prenom && emp.prenom.toLowerCase().includes(term)) ||
                emp.email.toLowerCase().includes(term) ||
                emp.shift.toLowerCase().includes(term)
            );
            displayEmployes(filteredEmployes);
        }

        async function loadAndGenerateFixedQR() {
            const { data, error } = await supabase.rpc('get_qr_fixed_token');
            if (error || !data) return showToast('Erreur chargement QR fixe.', 'error');
            const token = data;
            const canvas = document.createElement('canvas');
            canvas.id = 'qr-canvas';
            document.body.appendChild(canvas);
            try {
                await QRCode.toCanvas(canvas, token, { width: 200, margin: 2, color: { dark: '#000000', light: '#FFFFFF' } });
                const link = document.createElement('a');
                link.download = 'QR_Fixe_Bar.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('QR fixe téléchargé ! Imprimez et fixez au bar.', 'success');
            } catch (qrError) {
                showToast('Erreur génération QR: ' + qrError.message, 'error');
            } finally {
                document.body.removeChild(canvas);
            }
        }

        // openModal, loadSelfies, viewFullSelfie, closeModal, openCongesModal, loadConges, approuverConge, editHoraires, confirmDelete, logout, showToast (tous inclus, identiques à v3.2)
        async function openModal(empId) {
            selectedEmployeId = empId;
            const emp = employesData.find(e => e.id === empId);
            if (!emp) return;
            document.getElementById('modal-title').textContent = `${emp.prenom || ''} ${emp.nom}`;
            document.getElementById('modal-info').innerHTML = `
                <div class="info-item"><label>Email</label><value>${emp.email}</value></div>
                <div class="info-item"><label>Shift</label><value>${emp.shift}${emp.heure_debut ? ` (Matin: ${emp.heure_debut} - Soir: ${emp.heure_fin})` : ''}</value></div>
                <div class="info-item"><label>Statut</label><value>${emp.active ? 'Actif' : 'Inactif'}</value></div>
                ${emp.disabled_reason ? `<div class="info-item"><label>Raison inactif</label><value>${emp.disabled_reason}</value></div>` : ''}
            `;
            document.getElementById('horaires-display').textContent = `Shift actuel: ${emp.shift}. ${emp.heure_debut ? `Personnalisé: Début matin à ${emp.heure_debut}, fin soir à ${emp.heure_fin}.` : 'Horaires par défaut.'}`;
            await loadSelfies(empId);
            document.getElementById('modal-details').style.display = 'block';
        }

        async function loadSelfies(empId) {
            const { data } = await supabase.from('selfies').select('storage_path, created_at').eq('user_id', empId).order('created_at', { ascending: false }).limit(10);
            const grid = document.getElementById('selfies-grid');
            if (!data || !data.length) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">Aucun selfie enregistré.</p>';
            } else {
                grid.innerHTML = data.map(s => `<img src="${SUPABASE_URL}/storage/v1/object/public/selfies/${s.storage_path}" alt="Selfie du ${new Date(s.created_at).toLocaleDateString('fr-FR')}" class="selfie-img" onclick="viewFullSelfie(this.src)">`).join('');
            }
        }

        function viewFullSelfie(src) {
            window.open(src, '_blank');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function openCongesModal(empId) {
            selectedEmployeId = empId;
            const emp = employesData.find(e => e.id === empId);
            document.getElementById('conges-title').textContent = `Gestion des Congés - ${emp.prenom || ''} ${emp.nom}`;
            closeModal('modal-details');
            document.getElementById('modal-conges').style.display = 'block';
            await loadConges(empId);
        }

        async function loadConges(empId) {
            const { data, error } = await supabase.from('conges').select('*').eq('user_id', empId).order('date_debut', { ascending: false });
            if (error) return showToast('Erreur chargement congés: ' + error.message, 'error');
            const list = document.getElementById('conges-list');
            if (!data || !data.length) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucun congé enregistré.</p>';
            } else {
                list.innerHTML = data.map(c => {
                    const isPending = c.approuve === null;
                    const className = isPending ? 'conge-item pending' : (c.approuve ? 'conge-item' : 'conge-item rejected');
                    const status = isPending ? 'En attente' : (c.approuve ? 'Approuvé' : 'Rejeté');
                    return `
                        <div class="${className}">
                            <div class="conge-details">
                                <div class="conge-motif">${c.motif.replace('_', ' ')}</div>
                                <div class="conge-dates">Du ${c.date_debut} au ${c.date_fin}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="padding: 5px 10px; background: #e9ecef; border-radius: 5px; font-size: 12px; font-weight: bold;">${status}</span>
                                ${isPending ? `
                                    <button class="btn-approuver" onclick="approuverConge('${c.id}', true)">Approuver</button>
                                    <button class="btn-rejeter" onclick="approuverConge('${c.id}', false)">Rejeter</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        async function approuverConge(id, approuve) {
            const { error } = await supabase.from('conges').update({ approuve }).eq('id', id);
            if (error) return showToast('Erreur mise à jour congé: ' + error.message, 'error');
            showToast(`Congé ${approuve ? 'approuvé' : 'rejeté'} !`, 'success');
            await loadConges(selectedEmployeId);
            if (!approuve) {
                await supabase.from('employes').update({ active: false, disabled_reason: 'Congé rejeté' }).eq('id', selectedEmployeId);
                await loadEmployes();
            }
        }

        async function editHoraires(empId) {
            const emp = employesData.find(e => e.id === empId);
            const newShift = prompt('Nouveau shift (jour/nuit/personnalise):', emp.shift);
            if (!newShift || newShift === emp.shift) return closeModal('modal-details');
            let hDebut = emp.heure_debut, hFin = emp.heure_fin;
            if (newShift === 'personnalise') {
                hDebut = prompt('Heure début matin (HH:MM, ex: 07:30):', emp.heure_debut || '08:00');
                hFin = prompt('Heure fin soir (HH:MM, ex: 19:00):', emp.heure_fin || '18:00');
                if (!hDebut || !hFin) {
                    showToast('Heures invalides pour shift personnalisé.', 'error');
                    return;
                }
                if (hFin <= hDebut) {
                    showToast('Heure fin soir doit être après début matin.', 'error');
                    return;
                }
            }
            const { error } = await supabase.from('employes').update({
                shift: newShift,
                heure_debut: newShift === 'personnalise' ? hDebut : null,
                heure_fin: newShift === 'personnalise' ? hFin : null
            }).eq('id', empId);
            if (error) return showToast('Erreur mise à jour horaires: ' + error.message, 'error');
            showToast('Horaires mis à jour avec succès !', 'success');
            closeModal('modal-details');
            await loadEmployes();
        }

        async function confirmDelete(empId) {
            if (!confirm('Supprimer cet employé ? (Tous ses pointages et selfies seront supprimés via CASCADE)')) return;
            const { error } = await supabase.from('employes').delete().eq('id', empId);
            if (error) return showToast('Erreur suppression: ' + error.message, 'error');
            showToast('Employé supprimé !', 'success');
            closeModal('modal-details');
            await loadEmployes();
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Fermeture modals sur clic extérieur
        window.onclick = (event) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
